var fs = require('fs');
var oninc = require('util/oninc');
module.exports = function(canvas, dest, callback) {
    console.log('writing canvas ', canvas.width, 'x', canvas.height);
    if ((!canvas.width) || (!canvas.height)){
        console.log('BAD CANVAS: ', canvas);
        callback(new Error('bad canvas'));
    }

    try {
        stream = canvas.createPNGStream();
    } catch (e) {
        console.log(__filenanme, ', cannot create PNG stream.', dest);
    }
    
    try {
        var out = fs.createWriteStream(dest);
    } catch (e) {
        console.log(__filename, ', cannot create write stream for ', dest);
        throw e;
    }
    
    var p = 0;
    
    stream.on('data', function(chunk) {
        //console.log('writing chunk ', p++);
        out.write(chunk);
    });
    
    stream.on('error', function(err){
        console.log('write error: ', err);
        throw err;
    });

    stream.on('end', function() {
        console.log(__filename, ': written ', dest);
        if (callback) {
            callback();
        }
    });
    
    
}