var canvas_from_image = require('./from_image');
var colors = require('util/colors');

module.exports = function(path) {
    var canvas = canvas_from_image(path);
    var ctx = canvas.getContext('2d');

    var image_data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    var rgb_hsv_index = {};

    var hsv_data = [];
    var image_data_length = image_data.length;
    var five_percent = parseInt(image_data_length / 20);
    for (var image_data_index = 0; image_data_index < image_data_length; image_data_index += 4) {
        /**
         * as most documents repeat the same colors frequently,
         * indexing rgb/hsv indexes to reduce memory and calls to the conversion function.
         */

        var rgb_key = image_data[image_data_index] + ',' + image_data[image_data_index + 1] + ',' + image_data[image_data_index + 2];
        if (rgb_hsv_index.hasOwnProperty(rgb_key)) {
            var hsv = rgb_hsv_index[rgb_key];
        } else {
            var hsv = colors.rgb_to_hsv(image_data[image_data_index], image_data[image_data_index + 1], image_data[image_data_index + 2]);
            rgb_hsv_index[rgb_key] = hsv;
        }
        hsv_data.push(hsv);
        if (!(image_data_index % five_percent)) {
            console.log(__filename, ': ', image_data_index, ' of ', image_data_length, ': ', parseInt(100 * image_data_index / image_data_length), '%', hsv);
        }

    }

    return hsv_data;
}