var Gate = require('util/gate');
var ejs = require('ejs');
var fs = require('fs');
var properties_template = fs.readFileSync(__dirname + '/../templates/properties.html').toString();
var option_utils = require('./../utils/options');

module.exports = function(callback) {
    // console.log(__filename, ' initializing form ');
    var self = this;
    var gate = new Gate(function() {
        if (!self.configs.no_submit) {
            self.ensure_submit_button();
        }
        // console.log(__filename, ': done with GATE for init');
        callback(null, self);
    });
    gate.debug = true;

    this.fields.forEach(function(field, index) {
        if (typeof(field) == 'string') {
            self.fields[index] = field = {
                name: field
            };
        }
        // console.log(__filename, ' initializing field ', field.name);
        if (field.hasOwnProperty('callback')) {
            gate.task_start();
            field.callback(field, function() {
                console.log(__filename, ': done with field ', field.name);
                gate.task_done();
            });
        } else {
            // console.log(__filename, ':: init - no callback on ', field.name);
        }

        if (field.hasOwnProperty('properties') && field.properties && (typeof(field.properties) == 'object')) {
            field.properties = ejs.render(properties_template, {
                locals: {
                    properties: field.properties
                }
            });
        } else {
            field.properties = '';
        }

        if (field.hasOwnProperty('options')) {
            field.options = option_utils(field.options);
        }
    });

    gate.start();
}