var fs = require('fs');
var bin = require('util/binary');
//__dirname + '/megt90n000cb.img'
module.exports = function(path, expected, callback) {
    
    console.log(__filename, ': reading ', path);
    var file_info = fs.statSync(path);
    console.log(file_info);
    
    var ints = [];
    var handle = fs.createReadStream(path, {bufferSize:  64 * 1024})
    var read_size = 0;
    var last_percent = 0;
    handle.on('data', function(data) {
        var new_data = _read_bin_line(data);
        ints = ints.concat(new_data);
        read_size += ints.length;
        var percent = ints.length * 100 / expected;
        if  ((percent - last_percent) > 1) {
                   console.log(parseInt(percent), '% read ', ints.length, ' of ', expected, ' ints');

       last_percent = percent; 
        }
    });

    handle.on('end', function() {
        callback(null, ints);
    })

}

function _read_bin_line(data) {

    var l = data.length;
    var out = [];

    for (var offset = 0; offset < l; offset += 2) {
        var i = bin.int16(offset, 'big', data);
        out.push(i);
/*        
        if (offset > 0){
            var slope = i - last_i;
            var aslope = Math.abs(slope);
            
            if (!_slopes[aslope]){
                _slopes[aslope] = [0,0]
            }
            
            if (slope > 0){
                _slopes[aslope][1] ++;
            } else{
                _slopes[aslope][0] ++;
            }
        }
        
        var last_i = i;
*/
    }
    return out;
}

var _slopes = []