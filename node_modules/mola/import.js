var fs = require('fs');
var bin = require('util/binary');
var au = require('util/array');

//__dirname + '/megt90n000cb.img'
module.exports = function(path, expected, callback) {
    
    console.log(__filename, ': reading ', path);
    var file_info = fs.statSync(path);
    console.log(file_info);
    
    var ints = [];
    var handle = fs.createReadStream(path, {bufferSize:  64 * 1024})
    var read_size = 0;
    var last_percent = 0;
    var data_count = 0;
    
    handle.on('data', function(data) {
        ++data_count;
        var new_data = _read_bin_line(data);
        ints.push(new_data);
        read_size += new_data.length;
        var percent = read_size * 100 / expected;
        if  ((percent - last_percent) > 1) {
                   console.log(parseInt(percent), '% read ', read_size, ' of ', expected, ' ints');

       last_percent = percent; 
        }
    });

    handle.on('end', function() {
        console.log('flattening ', ints.length, 'int sets; ', data_count, ' batches');
        var flat_ints = au.flatten_2d_array(ints)[0];
        console.log('done reading ', path);
        callback(null, flat_ints);
    })

}

function _read_bin_line(data) {

    var l = data.length;
    var out = [];

    for (var offset = 0; offset < l; offset += 2) {
        var i = bin.int16(offset, 'big', data);
        out.push(i);
    }
    return out;
}

var _slopes = []