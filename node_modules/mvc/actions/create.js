var inflect = require('inflect');

module.exports = function(context) {
    var self = this;
     // console.log(__filename, ' creating new ', self.name, context.request.body);

    function _handler(err, result) {
        if (err) {
             // console.log(__filename, ': put err: ', err);
            context.flash('error in put', 'error', 'home');
        } else {
            context.flash(self.name + ' created');
            var red_path = '/' + inflect(self.name) + '/' + item._id;
             // console.log(__filename, ' redirecting to ', red_path);
            
            if (result.hasOwnProperty('height_data')){
                self.model.gen_coords(result);
            }
            context.response.redirect(red_path);
        }
    }

    function _get_handler(err, result2) {
        if (result2) {
            context.flash('There is already a ' + item._id + ' in ' + self.name, 'error', 'home');
        } else {
            self.model.put(item, _handler);
        }
    }

    if (!context.request.body.hasOwnProperty(self.name)) {
        context.flash(': no ' + self.name + ' in body', 'error', 'home');
    } else {
        var item = context.request.body[self.name];
         // console.log(__filename, ' putting ', item);
        if (item.hasOwnProperty('_id')) {
            self.model.get(item._id, _get_handler);
        } else {
            self.model.put(item, _handler);
        }
    }

}