var express = require('express/lib/express');
var boot_controller = require('./controller/load');
var fs = require('fs');

module.exports = function (app) {
     // console.log(__filename, 'laoding app');
    app.use(app.router);

    // Example 500 page
    app.error(function(err, req, res) {
        console.dir(err);
        res.render('500');
    });
    // Example 404 page via simple Connect middleware
    app.use(function(req, res) {
        res.render('404');
    });
    // Setup ejs views as default, with .html as the extension
    app.set('views', MVC_VIEWS);
    app.register('.html', require('ejs'));
    app.set('view engine', 'html');

    // Some dynamic view helpers
    app.dynamicHelpers({
        request: function(req) {
            return req;
        },
        hasMessages: function(req) {
	if (!req) return {};
            if (!req.hasOwnProperty('session')){
                 // console.log('no session in req: ');
               // console.log(req);
               return {};
            }
            return Object.keys(req.session.flash || {}).length;
        },
        messages: function(req) {
		if (!req) return [];

            return function() {
                if (!req.hasOwnProperty('flash')){ return []; }
                var msgs = req.flash();
                return Object.keys(msgs).reduce(function(arr, type) {
                    return arr.concat(msgs[type]);
                },
                []);
            }
        }
    });
    
    var controllers = fs.readdirSync(MVC_CONTROLLERS);
    var js_test = /(.*)\.js$/;
    controllers.forEach(function(filename){
	if (js_test(filename)){
	console.log(__filename, ': loading controller ', filename);
	    var match = js_test.exec(filename);
	    name = match[1];
	    boot_controller(name, app);
	//} else {
	//     // console.log(__filename, ': skipping ', filename);
	}
    });
    
    
}

