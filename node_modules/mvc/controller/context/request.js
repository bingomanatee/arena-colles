var param_module = require('mvc/params');
var util = require('util');

module.exports = function(Context, gate) {
    Context.prototype.flash = function(message, type, redirect_target) {
        if (!type) {
            type = 'info';
        }
        this.request.flash(type, message);
        if (redirect_target) {
            try {
                this.redirect(redirect_target);

            } catch (err) {
                console.log(__filename, ': flash - error in ', redirect_target, ': ', err);
            }
        }
    }

    Context.prototype.redirect = function(target) {
        this.response.redirect(target);
    }

    Context.prototype.params = function(params) {
        return param_module(this.controller.name, params);
    }

    Context.prototype.render = function(path, options) {
        if (!path) {
            path = this.controller._views[this.action];
        } else if (typeof(path) == 'object') {
            options = path;
            path = this.controller._views[this.action];
        }
        _.defaults(options, {js_paths: ['/js/jq.js'], js_inline: [], css_paths : [], css_inline: [] })
        console.log(__filename, ': render: path = ', path);
        try {
            this.response.render(path, options);
        } catch (err) {
            console.log(__filename, ': render ', path, ' - error : ', err);
        }
    }

    gate.task_done();
}