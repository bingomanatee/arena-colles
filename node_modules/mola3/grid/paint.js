var Canvas = require('canvas');
var fs = require('fs');
var util = require('util');
var draw_canvas = require('support/draw_canvas');

module.exports = function (write_path, filter) {

    var canvas = new Canvas(this.cols, this.rows);
    var ctx = canvas.getContext('2d');
    var id = ctx.getImageData(0, 0, this.cols, this.rows);

 //   console.log('painting into ca q     nvase %s x %s', this.cols, this.rows);
    var self = this;

    for (var r = 0; r < this.rows; ++r) for (var c = 0; c < this.cols; ++c) {
        var offset = ((r * self.cols) + c) * 4;
        id.data[offset] = r % 255;
        id.data[offset + 1] = c % 255;
        id.data[offset + 2] = 255;
        id.data[offset + 3] = 255;
    }
    function _on_cell(cell) {

        var offset = ((cell.row * self.cols) + cell.col) * 4;
        var image_data = filter(cell);

        id.data[ offset] = image_data[0];
        id.data[ offset + 1] = image_data[1];
        id.data[ offset + 2] = image_data[2];
        id.data[ offset + 3] = image_data[3];

    }

    this.each_cell(_on_cell);
    ctx.putImageData(id, 0, 0);

    draw_canvas(canvas, write_path);

}