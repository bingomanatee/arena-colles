var Canvas = require('canvas');
var fs = require('fs');

function draw_canvas(canvas, c_path) {
    console.log('drawing canvas to %s', c_path);

    var stream = canvas.createPNGStream();
    var out = fs.createWriteStream(c_path);

    stream.on('data', function (c) {
        out.write(c);
    });

    stream.on('end', function () {
        out.close();
    })

}

module.exports = function(path, filter){

    var canvas = new Canvas(this.cols, this.rows);
    var ctx = canvas.getContext('2d');
    var id = ctx.getImageData(0, 0, this.cols, this.rows);

    function _on_cell(cell){
        var offset = (cell.row * this.cols + cell.col) * 4;
        var image_data = filter(cell);
        cell.forEach(function(color, channel){
            id[channel + offset] = color;
        });
    }

    ctx.putImageData(id, 0, 0);

    this.each_cell(_on_cell);

    draw_canvas(canvas, path);

}