var fs = require('fs');
var Grid = require('./grid');

/**
 * reads in a byte stream of data;
 * returns a 2d array of ints
 *
 *
 * @param path: string -- an absolute filepath
 * @param cols: int -- the number of columns (width) of data.
 * @param callback: function
 */
module.exports = function (path, cols, callback) {

    var read_config = {
        bufferSize:64 * 1024
    };

    var ints = [];
    var int_rows = [];

    var handle = fs.createReadStream(path, read_config);

    handle.on('data', function (data_buffer) {

        for (var s = 0; s < data_buffer.length; s += 2) {
            ints.push(data_buffer.readInt16BE(s));
        }

        while (ints.length >= cols) {
            var slice = ints.slice(0, cols);
            int_rows.push(slice);
            ints = ints.slice(cols);
        }
    });

    handle.on('end', function () {
        if (ints.length) {
            int_rows.push(ints);
        }
        callback(null, new Grid(int_rows, null, cols));

    });

}